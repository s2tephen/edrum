<% content_for :title, "Compose" %>

<%= javascript_tag "var sequence = #{@sequence.to_json}" %>

<button class="start-compose-btn" id="start-compose-btn"><i class="fa fa-play"></i></button>
<button class="stop-compose-btn" id="stop-compose-btn"><i class="fa fa-stop"></i></button>

<button class="play-compose-btn" id="play-compose-btn" disabled>Demo track</button>





<script>
  var hits = [];
  $("#start-compose-btn").click(function(e) {
    console.log("start");
    var id = sequence.id;
    $.post('/compose/'+id+'/start', function(data) {});
    var hitSource = new EventSource("/serial");
    hitSource.onmessage = function(e) {
      var hit = jQuery.parseJSON (e.data);
      console.log(hit);
      hits.push(hit);
    }
  });

  // hit form: [h:4,23643,1]
  $("#stop-compose-btn").click(function(e) {
    $("#play-compose-btn").removeAttr("disabled");
    console.log("hit button");
    // hits.push("[h:4,23643,1]"); // for testing
    if (hits.length != 0) {
      $.ajax({
        type : "POST",
        url :  '/compose/send/' + sequence.id,
        dataType: 'json',
        contentType: 'application/json',
        data : JSON.stringify( {"hits" : hits} )
      });
    } else {
      alert("You must hit start and then hit notes first!");
    }
  });

  $("#play-compose-btn").click(function(e) {
    window.location.href = "/practice/" + sequence.id;
  });

    // hitSource.onopen = function (e) {
    //   console.log("OPEN state \n"+e.data);
    // };

    // hitSource.onmessage = function(e) {
    //   var hit = jQuery.parseJSON( e.data );
    //   console.log(hit.drum);

      // TODO: start time needs to accurately correlate to bar/beat in sequence
      // TODO: support for checking if both notes at same time are hit
    //   if (hit.drum == drawSequence.notes[hit.start].drum) {
    //     console.log("HIT");
    //     stepSequence();
    //   }
    // };

    // hitSource.onerror = function (e) {
    //    console.log("Error State  \n\n"+e.data);
    // };
  // }
</script>